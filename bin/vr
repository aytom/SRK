#!/bin/bash
### BEGIN INIT INFO
# Provides:          v2ray
# Short-Description: Fast tunnel proxy that helps you bypass firewalls
# Description:       Start or stop the v2ray client
### END INIT INFO

# Author: vinew.cc

NAME=v2ray
DIR=$HOME/APP/SRK
PAC_PID=$DIR/pid/pac.pid
V2RAY_PID=$DIR/pid/v2ray.pid
LOG=$DIR/v2ray/v2ray.log
RET_VAL=0

if [ ! -d $DIR/pid ]; then
    mkdir -p $DIR/pid
    if [ $? -ne 0 ]; then
        echo "Creating PID directory $DIR failed"
        exit 1
    fi
fi

check_PAC() {
    if [ -r $PAC_PID ]; then
        read PAC < $PAC_PID
        if ps -p $PAC | grep SimpleHTTPServer >/dev/null; then
            return 0
        else
            rm -f $PAC_PID
            return 1
        fi
    else
        return 2
    fi
}

check_v2ray() {
    if [ -r $V2RAY_PID ]; then
        read V2RAY < $V2RAY_PID
        if ps -p $V2RAY | grep v2ray >/dev/null; then
            return 0
        else
            rm -f $V2RAY_PID
            return 1
        fi
    else
        return 2
    fi
}

start(){
    if check_v2ray; then
        echo "$NAME (pid $V2RAY) is already running..."
        return 0
    fi
    if check_PAC; then
        echo "PAC (pid $PAC) is already running..."
    else
        bash ${DIR}/pac.sh
        echo "Starting PAC success"
    fi
    bash ${DIR}/vr.sh
    if check_v2ray; then
        echo "Starting $NAME success"
    else
        echo "Starting $NAME failed"
        RET_VAL=1
    fi
}

stop(){
    if check_PAC; then
        kill -9 $PAC
        rm -f $PAC_PID
        echo "Stopping PAC success"
    else
        echo "PAC is stopped"
    fi
    if check_v2ray; then
        kill -9 $V2RAY
        rm -f $V2RAY_PID
        rm -rf $LOG
        echo "Stopping $NAME success"
    else
        echo "$NAME is stopped"
        RET_VAL=1
    fi
}

status(){
    check_PAC
    case $? in
        0)
        echo "PAC (pid $PAC) is running..."
        ;;
        1|2)
        echo "PAC is stopped"
        RET_VAL=1
        ;;
    esac
    check_v2ray
    case $? in
        0)
        echo "$NAME (pid $V2RAY) is running..."
        ;;
        1|2)
        echo "$NAME is stopped"
        RET_VAL=1
        ;;
    esac
}

log() {
   tail -f $LOG
}

pacupdate() {
   bash ${DIR}/gfwlist2pac.sh
}

case "$1" in
'start')
    start
    ;;   
'stop')
    stop
    ;; 
'status')
    status
    ;;
'restart')
    stop
    start
    RETVAL=$?
    ;;
'log')
    log
    ;;
'pacupdate')
    pacupdate
    ;; 
*)
    echo "Usage: $0 { start | stop | restart | status | log | pacupdate}"
    RETVAL=1
    ;;
esac
exit $RETVAL